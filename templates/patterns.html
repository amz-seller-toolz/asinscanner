{% extends "base.html" %}
{% block content %}
  <h2>Patterns</h2>
  <form method="post" class="mb-3">
    <div class="row g-2">
      <div class="col-md-3"><input name="name" placeholder="Name" class="form-control" /></div>
      <div class="col-md-4"><input name="pattern" placeholder="RegExp" class="form-control" /></div>
      <div class="col-md-2"><input name="flags" placeholder="Flags (int)" class="form-control" /></div>
      <div class="col-md-3"><button class="btn btn-success">Hinzufügen</button></div>
    </div>
    <div class="mt-2">
      <small>Benutze Python `re` Flags als Integer (z.B. re.IGNORECASE == 2). Für default (0) leer lassen.</small>
    </div>
  </form>

  <!-- Button to open generator modal -->
  <button type="button" class="btn btn-secondary mb-2" data-bs-toggle="modal" data-bs-target="#regexModal">
    Regex generieren (AI)
  </button>

  <!-- Modal -->
  <div class="modal fade" id="regexModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Regex-Generator (Beispiele)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label>Positive Beispiele (je eine Zeile)</label>
            <textarea id="positives" class="form-control" rows="6"></textarea>
          </div>
          <div class="mb-3">
            <label>Negative Beispiele (optional)</label>
            <textarea id="negatives" class="form-control" rows="4"></textarea>
          </div>
          <div id="rg-status" class="text-muted small"></div>
        </div>
        <div class="modal-footer">
          <button type="button" id="generateRegexBtn" class="btn btn-primary">Generiere Regex</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schliessen</button>
        </div>
      </div>
    </div>
  </div>

  <table class="table table-sm">
    <thead><tr><th>Name</th><th>Pattern</th><th>Flags</th><th>Active</th><th>Actions</th></tr></thead>
    <tbody>
    {% for p in patterns %}
      <tr>
        <td>{{ p.name }}</td>
        <td><code>{{ p.pattern|e }}</code></td>
        <td>{{ p.flags }}</td>
        <td>{{ 'yes' if p.active else 'no' }}</td>
        <td>
          <a href="{{ url_for('pattern_toggle', pid=p.id) }}" class="btn btn-sm btn-secondary">Toggle</a>
          <a href="{{ url_for('pattern_delete', pid=p.id) }}" class="btn btn-sm btn-danger">Delete</a>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>

  <script>
  document.getElementById('generateRegexBtn').addEventListener('click', async function(){
    const pos = document.getElementById('positives').value.trim();
    if(!pos){ alert('Bitte mindestens ein positives Beispiel angeben.'); return; }
    const neg = document.getElementById('negatives').value.trim();
    const status = document.getElementById('rg-status');
    status.textContent = 'Generiere...';
    try {
      const resp = await fetch('{{ url_for("suggest_regex") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({positives: pos.split(/\r?\n/), negatives: neg ? neg.split(/\r?\n/) : []})
      });
      const data = await resp.json();
      if(resp.ok && data.regex){
        const patternInput = document.querySelector('input[name="pattern"], textarea[name="pattern"]');
        if(patternInput) patternInput.value = data.regex;
        status.textContent = 'Regex generiert.';
        setTimeout(()=>{ var modal = bootstrap.Modal.getInstance(document.getElementById('regexModal')); if(modal) modal.hide(); }, 700);
      } else {
        status.textContent = 'Fehler: ' + (data.error || 'Keine Regex erhalten');
      }
    } catch (e) {
      status.textContent = 'Fehler: ' + e;
    }
  });
  </script>
{% endblock %}
