{% extends "base.html" %}
{% block content %}
  <h2>Patterns</h2>
  <form method="post" class="mb-3">
    <div class="row g-2">
      <div class="col-md-3"><input name="name" placeholder="Name" class="form-control" /></div>
      <div class="col-md-4"><input name="pattern" placeholder="RegExp" class="form-control" /></div>
    </div>
    <div class="mt-2"></div>
  </form>

  <!-- Button to open generator modal -->
  <button type="button" class="btn btn-secondary mb-2" data-bs-toggle="modal" data-bs-target="#regexModal">
    Regex generieren (AI)
  </button>

  <!-- Modal (complete markup) -->
  <div class="modal fade" id="regexModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Regex-Generator (Beispiele)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="positives" class="form-label">Positive Beispiele (je eine Zeile)</label>
            <textarea id="positives" class="form-control" rows="6"></textarea>
          </div>
          <div class="mb-3">
            <label for="negatives" class="form-label">Negative Beispiele (optional)</label>
            <textarea id="negatives" class="form-control" rows="4"></textarea>
          </div>
          <div id="rg-status" class="text-muted small"></div>
        </div>
        <div class="modal-footer">
          <button type="button" id="generateRegexBtn" class="btn btn-primary">Generiere Regex</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schliessen</button>
        </div>
      </div>
    </div>
  </div>

  <table class="table table-sm">
    <thead><tr><th>Name</th><th>Pattern</th><th>Flags</th><th>Active</th><th>Actions</th></tr></thead>
    <tbody>
    {% for p in patterns %}
      <tr>
        <td>{{ p.name }}</td>
        <td>{{ p.pattern }}</td>
        <td>{{ p.flags }}</td>
        <td>{{ 'Yes' if p.active else 'No' }}</td>
        <td><!-- actions --></td>
      </tr>
    {% else %}
      <tr><td colspan="5">Keine Patterns</td></tr>
    {% endfor %}
    </tbody>
  </table>

  <script>
  // Ensure DOM is ready and elements exist before attaching listeners
  document.addEventListener('DOMContentLoaded', function () {
    const genBtn = document.getElementById('generateRegexBtn');
    if (!genBtn) return;
    genBtn.addEventListener('click', async function(){
      const pos = document.getElementById('positives').value.trim();
      if(!pos){ alert('Bitte mindestens ein positives Beispiel angeben.'); return; }
      const neg = document.getElementById('negatives').value.trim();
      const status = document.getElementById('rg-status');
      status.textContent = 'Generiere...';
      try {
        const resp = await fetch('{{ url_for("suggest_regex") }}', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({positives: pos.split(/\r?\n/), negatives: neg ? neg.split(/\r?\n/) : []})
        });
        const data = await resp.json();
        if(resp.ok && data.regex){
          const patternInput = document.querySelector('input[name="pattern"], textarea[name="pattern"]');
          if(patternInput) patternInput.value = data.regex;
          status.textContent = 'Regex generiert.';
          setTimeout(()=>{ const modalEl = document.getElementById('regexModal'); const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl); modal.hide(); }, 700);
        } else {
          status.textContent = 'Fehler: ' + (data.error || 'Keine Regex erhalten');
        }
      } catch (e) {
        status.textContent = 'Fehler: ' + e;
      }
    });
  });
  </script>
{% endblock %}
