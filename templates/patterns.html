{% extends "base.html" %}
{% block content %}
  <h2>Patterns</h2>

  <!-- Create pattern form -->
  <form method="post" action="{{ url_for('patterns') }}" class="mb-3">
    <div class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label small">Name</label>
        <input name="name" placeholder="Name" class="form-control" required />
      </div>
      <div class="col-md-4">
        <label class="form-label small">Pattern</label>
        <input name="pattern" placeholder="RegExp" class="form-control" required />
      </div>
      <div class="col-md-2">
        <label class="form-label small">Flags (int)</label>
        <input name="flags" placeholder="0" class="form-control" />
      </div>
      <div class="col-md-2">
        <label class="form-label small">Active</label>
        <select name="active" class="form-select">
          <option value="1" selected>Yes</option>
          <option value="0">No</option>
        </select>
      </div>
      <div class="col-md-12 mt-2">
        <label class="form-label small">Description</label>
        <input name="description" placeholder="Beschreibung (optional)" class="form-control" />
      </div>
    </div>
    <div class="mt-2">
      <button type="submit" class="btn btn-primary">Pattern hinzufügen</button>
    </div>
  </form>

  <!-- Button to open generator modal -->
  <button type="button" class="btn btn-secondary mb-3" data-bs-toggle="modal" data-bs-target="#regexModal">
    Regex generieren (AI)
  </button>

  <!-- Modal (complete markup) -->
  <div class="modal fade" id="regexModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Regex-Generator (Beispiele)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="positives" class="form-label">Positive Beispiele (je eine Zeile)</label>
            <textarea id="positives" class="form-control" rows="6"></textarea>
          </div>
          <div class="mb-3">
            <label for="negatives" class="form-label">Negative Beispiele (optional)</label>
            <textarea id="negatives" class="form-control" rows="4"></textarea>
          </div>
          <div id="rg-status" class="text-muted small"></div>
        </div>
        <div class="modal-footer">
          <button type="button" id="generateRegexBtn" class="btn btn-primary">Generiere Regex</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schliessen</button>
        </div>
      </div>
    </div>
  </div>

  <table class="table table-sm">
    <thead>
      <tr>
        <th>Name</th>
        <th>Pattern</th>
        <th>Flags</th>
        <th>Active</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
    {% for p in patterns %}
      <tr>
        <td>{{ p.name }}</td>
        <td><code>{{ p.pattern }}</code></td>
        <td>{{ p.flags }}</td>
        <td>{{ 'Yes' if p.active else 'No' }}</td>
        <td>
          <!-- app.py defines pattern_toggle and pattern_delete expecting GET, use links to match -->
          <a href="{{ url_for('pattern_toggle', pid=p.id) }}" class="btn btn-sm btn-outline-secondary">
            {{ 'Deactivate' if p.active else 'Activate' }}
          </a>
          <a href="{{ url_for('pattern_delete', pid=p.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Sicher löschen?');">
            Löschen
          </a>
        </td>
      </tr>
    {% else %}
      <tr><td colspan="5">Keine Patterns</td></tr>
    {% endfor %}
    </tbody>
  </table>

  <script>
  // Ensure DOM is ready and elements exist before attaching listeners
  document.addEventListener('DOMContentLoaded', function () {
    const genBtn = document.getElementById('generateRegexBtn');
    if (!genBtn) return;
    genBtn.addEventListener('click', async function(){
      const posTxt = document.getElementById('positives').value.trim();
      if(!posTxt){ alert('Bitte mindestens ein positives Beispiel angeben.'); return; }
      const negTxt = document.getElementById('negatives').value.trim();
      const status = document.getElementById('rg-status');
      status.textContent = 'Generiere...';
      try {
        const resp = await fetch('{{ url_for("suggest_regex") }}', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            positives: posTxt.split(/\r?\n/).filter(Boolean),
            negatives: negTxt ? negTxt.split(/\r?\n/).filter(Boolean) : []
          })
        });
        const data = await resp.json();
        if(resp.ok && data.regex){
          const patternInput = document.querySelector('input[name="pattern"], textarea[name="pattern"]');
          if(patternInput) patternInput.value = data.regex;
          status.textContent = 'Regex generiert.';
          setTimeout(()=>{ const modalEl = document.getElementById('regexModal'); const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl); modal.hide(); }, 700);
        } else {
          status.textContent = 'Fehler: ' + (data.error || 'Keine Regex erhalten');
        }
      } catch (e) {
        status.textContent = 'Fehler: ' + e;
      }
    });
  });
  </script>
{% endblock %}
